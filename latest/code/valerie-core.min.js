/* valerie - MIT license - (c) egrove Ltd (egrove.co.uk) */
var valerie={};!function(){"use strict";valerie.utils={};var a=valerie.utils;a.asArray=function(b){return a.isArray(b)?b:[b]},a.asFunction=function(b){return a.isFunction(b)?b:function(){return b}},a.isArray=function(a){return"[object Array]"==={}.toString.call(a)},a.isArrayOrObject=function(a){return null===a?!1:"object"==typeof a},a.isFunction=function(a){return null==a?!1:"function"==typeof a},a.isMissing=function(b){return null==b?!0:a.isString(b)?0===b.length:!1},a.isObject=function(b){return null===b?!1:a.isArray(b)?!1:"object"==typeof b},a.isString=function(a){return"[object String]"==={}.toString.call(a)},a.mergeOptions=function(b,c){var d,e,f={};null==b&&(b={}),null==c&&(c={});for(d in b)b.hasOwnProperty(d)&&(e=b[d],a.isArray(e)&&(e=e.slice(0)),f[d]=e);for(d in c)c.hasOwnProperty(d)&&(f[d]=c[d]);return f}}(),function(){"use strict";valerie.formatting={};var a=valerie.formatting;a.addThousandsSeparator=function(a,b,c){var d=a.toString().split(c),e=d[0];return e=e.replace(/\B(?=(\d{3})+(?!\d))/g,b),d[0]=e,d.join(c)},a.pad=function(a,b,c){return a=a.toString(),a.length>=c?a:new Array(c+1-a.length).join(b)+a},a.replacePlaceholders=function(a,b){return null==b&&(b={}),a.replace(/\{(\w+)\}/g,function(a,c){var d=b[c];return null==d?a:d.toString()})}}(),function(){"use strict";valerie.dom={};var a=/\s+/g,b=/^\s+|\s+$/g,c=valerie.dom;c.classNamesDictionaryToString=function(a){var b,c=[];for(b in a)a.hasOwnProperty(b)&&a[b]&&c.push(b);return c.sort(),c.join(" ")},c.classNamesStringToDictionary=function(c){var d,e,f={};if(null==c)return f;if(c=c.replace(b,""),0===c.length)return f;for(d=c.split(a),e=0;e<d.length;e++)f[d[e]]=!0;return f},c.setElementVisibility=function(a,b){var c="none"!==a.style.display;c!==b&&(a.style.display=b?"":"none")}}(),function(){"use strict";valerie.koExtras={},valerie.koExtras.isolatedBindingHandler=function(a,b){var c=1===arguments.length?function(){}:a;return b=2===arguments.length?b:a,{init:function(a,d,e,f,g){c(a,d,e,f,g),ko.computed({read:function(){b(a,d,e,f,g)},disposeWhenNodeIsRemoved:a})}}},valerie.koExtras.pausableComputed=function(a,b,c,d){var e,f,g;return f=null==d?ko.observable(!1):ko.utils.isSubscribable(d)?d:ko.observable(d),g=ko.computed(function(){return f()?e:a.call(b)},b,c),g.paused=ko.computed({read:function(){return f()},write:function(a){a&&(a=!0),a!==f()&&(a&&(e=g()),f(a))}}),g.refresh=function(){f()&&(f(!1),e=g(),f(!0))},g}}(),function(){"use strict";valerie.converters={},valerie.converters.passThrough={format:function(a){return null==a?"":a.toString()},parse:function(a){return a}}}(),function(){"use strict";var a={failed:{},passed:{},pending:{}};valerie.ValidationResult=function(b,c){null==c&&(c=""),this.state=b,this.message=c,this.failed=b===a.failed,this.passed=b===a.passed,this.pending=b===a.pending},valerie.ValidationResult.states=a,valerie.ValidationResult.passedInstance=new valerie.ValidationResult(a.passed),valerie.ValidationResult.pendingInstance=new valerie.ValidationResult(a.pending),valerie.ValidationResult.createFailedResult=function(b){return new valerie.ValidationResult(a.failed,b)}}(),function(){"use strict";valerie.validationState={};var a="validation",b=valerie.utils;valerie.validationState.findIn=function(a,c,d,e){1 in arguments||(c=!0),2 in arguments||(d=!1),3 in arguments||(e=[]);var f,g,h;for(f in a)if(a.hasOwnProperty(f)){if(h=a[f],null==h)continue;if(g=valerie.validationState.getFor(h),ko.isObservable(h)&&(h=h.peek()),b.isFunction(h))continue;g&&(g instanceof valerie.PropertyValidationState?e.push(g):c&&e.push(g)),d&&b.isArrayOrObject(h)&&valerie.validationState.findIn(h,c,!0,e)}return e},valerie.validationState.getFor=function(b){return null==b?null:b.hasOwnProperty(a)?b[a]():null},valerie.validationState.has=function(b){return null==b?!1:b.hasOwnProperty(a)},valerie.validationState.setFor=function(b,c){b[a]=function(){return c}}}(),function(){"use strict";var a={deferEvaluation:!0},b=valerie.utils,c=valerie.ValidationResult.passedInstance,d=valerie.ValidationResult.pendingInstance,e=ko.observable,f=ko.computed,g=function(){return this.result().failed},h=function(){var a,b,c,d=[],e=this.validationStates();for(c=0;c<e.length;c++)a=e[c],a.isApplicable()&&(b=a.result(),b.failed&&d.push(a));return d},i=function(){return this.result().message},j=function(){return this.result().passed},k=function(){return this.result().pending},l=function(){var a,b,c=[],d=this.validationStates();for(b=0;b<d.length;b++)a=d[b],a.isApplicable()&&a.result().pending&&c.push(a);return c},m=function(){return this.failedStates().length>0?valerie.ValidationResult.createFailedResult(this.settings.failureMessageFormat):this.pendingStates().length>0?d:c},n=function(){var a,b=this.validationStates();for(a=0;a<b.length;a++)if(b[a].touched())return!0;return!1},o=function(a){var b,c,d=this.validationStates();for(b=0;b<d.length;b++)c=d[b],c.isApplicable()&&c.touched(a)};valerie.ModelValidationState=function(c,d){d=b.mergeOptions(valerie.ModelValidationState.defaultOptions,d),d.applicable=b.asFunction(d.applicable),d.name=b.asFunction(d.name),this.failed=f(g,this,a),this.failedStates=f(h,this,a),this.message=f(i,this,a),this.model=c,this.passed=f(j,this,a),this.pending=f(k,this,a),this.pendingStates=f(l,this,a),this.result=valerie.koExtras.pausableComputed(m,this,a,d.paused),this.paused=this.result.paused,this.refresh=this.result.refresh,this.settings=d,this.getName=function(){return this.settings.name()},this.isApplicable=function(){return this.settings.applicable()},this.summary=e([]),this.touched=f({read:n,write:o,deferEvaluation:!0,owner:this}),this.validationStates=ko.observableArray()},valerie.ModelValidationState.prototype={addValidationStates:function(a){return a=b.asArray(a),this.validationStates.push.apply(this.validationStates,a),this},applicable:function(a){return null==a&&(a=!0),this.settings.applicable=b.asFunction(a),this},clearSummary:function(a){var b,c,d;if(this.summary([]),a)for(b=this.validationStates(),d=0;d<b.length;d++)c=b[d],c.clearSummary&&c.clearSummary(!0);return this},end:function(){return this.model},includeInSummary:function(){return this.settings.excludeFromSummary=!1,this},name:function(a){return this.settings.name=b.asFunction(a),this},removeValidationStates:function(a){return a=b.asArray(a),this.validationStates.removeAll(a),this},startValidatingSubModel:function(a){return this.validationStates.push(a.validation()),this},stopValidatingSubModel:function(a){return this.validationStates.remove(a.validation()),this},updateSummary:function(a){var b,c,d=this.failedStates(),e=[];for(c=0;c<d.length;c++)b=d[c],b.settings.excludeFromSummary||e.push({name:b.getName(),message:b.message()});if(this.summary(e),a)for(d=this.validationStates(),c=0;c<d.length;c++)b=d[c],b.isApplicable()&&b.updateSummary&&b.updateSummary(!0);return this},validateAll:function(){var a=valerie.validationState.findIn(this.model,!0,!0);return this.addValidationStates(a),this},validateAllProperties:function(){var a=valerie.validationState.findIn(this.model,!1,!0);return this.addValidationStates(a),this},validateChildProperties:function(){var a=valerie.validationState.findIn(this.model,!1,!1);return this.addValidationStates(a),this},validateChildPropertiesAndSubModels:function(){var a=valerie.validationState.findIn(this.model,!0,!1);return this.addValidationStates(a),this}},valerie.ModelValidationState.defaultOptions={applicable:b.asFunction(!0),excludeFromSummary:!0,failureMessageFormat:"",name:b.asFunction("(?)"),paused:null},valerie.validatableModel=function(a,b){var c=new valerie.ModelValidationState(a,b);return valerie.validationState.setFor(a,c),c}}(),function(){"use strict";var a={deferEvaluation:!0},b=valerie.utils,c=valerie.formatting,d=valerie.koExtras,e=ko.observable,f=ko.computed,g=valerie.ValidationResult.passedInstance,h=function(a){var b=a.observableOrComputed(),c=a.settings.missingTest(b),d=a.settings.required();return c&&d?-1:c&&!d?0:1},i=function(a){var b,c,d,e=a.observableOrComputed(),f=a.settings.rules;for(d=0;d<f.length;d++)if(b=f[d],c=b.test(e),c.failed||c.pending)return c;return g},j=function(){return this.result().failed},k=function(){var a=this.result().message;return a=c.replacePlaceholders(a,{name:this.settings.name()})},l=function(){return this.result().passed},m=function(){return this.result().pending},n=function(){var a,b;return b=this.boundEntry.result(),b.failed?b:(a=h(this),-1===a?valerie.ValidationResult.createFailedResult(this.settings.missingFailureMessage):0===a?b:i(this))},o=function(){return this.settings.applicable()?this.touched()&&this.result().failed:!1};valerie.PropertyValidationState=function(c,h){h=b.mergeOptions(valerie.PropertyValidationState.defaultOptions,h),h.applicable=b.asFunction(h.applicable),h.name=b.asFunction(h.name),h.required=b.asFunction(h.required),this.boundEntry={focused:e(!1),result:e(g),textualInput:!1},this.failed=f(j,this,a),this.message=d.pausableComputed(k,this,a),this.passed=f(l,this,a),this.observableOrComputed=c,this.pending=f(m,this,a),this.result=f(n,this,a),this.settings=h,this.getName=function(){return this.settings.name()},this.isApplicable=function(){return this.settings.applicable()},this.showMessage=d.pausableComputed(o,this,a),this.touched=e(!1)},valerie.PropertyValidationState.prototype={addRule:function(a){return this.settings.rules.push(a),this},applicable:function(a){return null==a&&(a=!0),this.settings.applicable=b.asFunction(a),this},end:function(){var a,b,c=this.settings,d=c.valueFormat,e=c.rules;for(a=0;a<e.length;a++)b=e[a].settings,b.valueFormat=d;return this.observableOrComputed},entryFormat:function(a){return this.settings.entryFormat=a,this},excludeFromSummary:function(){return this.settings.excludeFromSummary=!0,this},name:function(a){return this.settings.name=b.asFunction(a),this},required:function(a){return null==a&&(a=!0),this.settings.required=b.asFunction(a),this},valueFormat:function(a){return this.settings.valueFormat=a,this}},valerie.PropertyValidationState.defaultOptions={applicable:b.asFunction(!0),converter:valerie.converters.passThrough,entryFormat:null,excludeFromSummary:!1,invalidEntryFailureMessage:"",missingFailureMessage:"",missingTest:b.isMissing,name:b.asFunction(),required:b.asFunction(!1),rules:[],valueFormat:null},valerie.validatableProperty=function(a,b){if(!ko.isSubscribable(a))throw"Only observables or computeds can be made validatable properties.";var c=new valerie.PropertyValidationState(a,b);return valerie.validationState.setFor(a,c),c}}(),function(){"use strict";ko.computed.fn.validate=function(a){return valerie.validatableProperty(this,a)}}(),function(){"use strict";ko.observable.fn.validate=function(a){return valerie.validatableProperty(this,a)},ko.observableArray.fn.validateAsModel=function(a){return valerie.validatableModel(this,a)},ko.observableArray.fn.propertyValidationState=function(a){return new valerie.PropertyValidationState(this,a)}}(),function(){"use strict";var a=valerie.ValidationResult.passedInstance,b=valerie.utils,c=valerie.dom,d=c.setElementVisibility,e=valerie.converters,f=valerie.validationState.getFor,g=ko.bindingHandlers,h=ko.utils.registerEventHandler,i=valerie.koExtras.isolatedBindingHandler;!function(){var c=g.checked,d=g.value,e=function(a,b){var c=f(b);c.touched(!0),c.boundEntry.focused(!1),c.message.paused(!1),c.showMessage.paused(!1)},i=function(a,b){var c,d=f(b);d.boundEntry.result.peek().failed||(c=b.peek(),a.value=d.settings.converter.format(c,d.settings.entryFormat))},j=function(a,b){var c=f(b);c.boundEntry.focused(!0),c.message.paused(!0),c.showMessage.paused(!0)},k=function(b,c){var d,e=ko.utils.stringTrim(b.value),g=f(c),h=g.settings,i=a;0===e.length?(c(null),h.required()&&(i=valerie.ValidationResult.createFailedResult(h.missingFailureMessage))):(d=h.converter.parse(e),c(d),null==d&&(i=valerie.ValidationResult.createFailedResult(h.invalidEntryFailureMessage))),g.boundEntry.result(i)},l=function(b,c,d){var e=b();c.boundEntry.focused.peek()||(c.boundEntry.result(a),d.value=c.settings.converter.format(e,c.settings.entryFormat))};g.validatedChecked={init:function(a,d,g,i,j){var k=d(),l=f(k);c.init(a,d,g,i,j),l&&(h(a,"blur",function(){e(a,k)}),null==l.settings.name()&&(l.settings.name=b.asFunction(a.name)))},update:c.update},g.validatedValue={init:function(a,c,g,m,n){var o,p,q=c(),r=f(q);return r?(null==r.settings.name()&&(r.settings.name=b.asFunction(a.name)),h(a,"blur",function(){e(a,q)}),o=a.tagName.toLowerCase(),(p="input"===o&&"text"===a.type.toLowerCase()||"textarea"===o)?(r.boundEntry.textualInput=!0,h(a,"blur",function(){i(a,q)}),h(a,"focus",function(){j(a,q)}),h(a,"keyup",function(){k(a,q)}),ko.computed({read:function(){l(q,r,a)},disposeWhenNodeIsRemoved:a}),void 0):(d.init(a,c,g,m,n),void 0)):(d.init(a,c,g,m,n),void 0)},update:function(a,b,c,e,g){var h=b(),i=f(h);i&&i.boundEntry.textualInput||d.update(a,b,c,e,g)}}}(),function(){var a=function(a,b,c,d,e){var g,h=d(),i=c();i===!0&&(i=h.value||h.checked||h.validatedValue||h.validatedChecked||e),g=f(i),g&&a(g,i,h)};g.disabledWhenNotValid=i(function(b,c,d,e){var f=function(a){b.disabled=!a.passed()};a(f,b,c,d,e)}),g.disabledWhenTouchedAndNotValid=i(function(b,c,d,e){var f=function(a){b.disabled=a.touched()&&!a.passed()};a(f,b,c,d,e)}),g.enabledWhenApplicable=i(function(b,c,d,e){var f=function(a){b.disabled=!a.settings.applicable()};a(f,b,c,d,e)}),g.formattedText=i(function(a,b,c){var d,g=c(),h=b(),i=ko.utils.unwrapObservable(h),j=f(h),k=e.passThrough.format;j&&(k=j.settings.converter.format,d=j.settings.valueFormat),k=g.formatter||k,null==d&&(d=g.valueFormat),ko.utils.setTextContent(a,k(i,d))}),g.validationCss=i(function(b,d,e,f){var h=function(a){var d=g.validationCss.classNames,e=b.className,f=c.classNamesStringToDictionary(e),h=a.failed(),i=!1,j=a.passed(),k=a.pending(),l=a.touched(),m=!l;a.boundEntry&&a.boundEntry.focused()&&(i=!0),f[d.failed]=h,f[d.focused]=i,f[d.passed]=j,f[d.pending]=k,f[d.touched]=l,f[d.untouched]=m,b.className=c.classNamesDictionaryToString(f)};a(h,b,d,e,f)}),g.validationCss.classNames={failed:"failed",focused:"focused",passed:"passed",pending:"pending",touched:"touched",untouched:"untouched"},g.validationMessage=i(function(b,c,e,f){var g=function(a){d(b,a.showMessage()),ko.utils.setTextContent(b,a.message())};a(g,b,c,e,f)}),g.validationMessageText=i(function(b,c,d,e){var f=function(a){ko.utils.setTextContent(b,a.message())};a(f,b,c,d,e)}),g.visibleWhenApplicable=i(function(b,c,e,f){var g=function(a){d(b,a.isApplicable())};a(g,b,c,e,f)}),g.visibleWhenFocused=i(function(b,c,e,f){var g=function(a){d(b,a.focused())};a(g,b,c,e,f)}),g.visibleWhenInvalid=i(function(b,c,e,f){var g=function(a){d(b,a.failed())};a(g,b,c,e,f)}),g.visibleWhenSummaryNotEmpty=i(function(b,c,e,f){var g=function(a){d(b,a.summary().length>0)};a(g,b,c,e,f)}),g.visibleWhenTouched=i(function(b,c,e,f){var g=function(a){d(b,a.touched())};a(g,b,c,e,f)}),g.visibleWhenUntouched=i(function(b,c,e,f){var g=function(a){d(b,!a.touched())};a(g,b,c,e,f)}),g.visibleWhenValid=i(function(b,c,e,f){var g=function(a){d(b,a.passed())};a(g,b,c,e,f)})}()}(),function(){"use strict";var a=ko.bindingHandlers.checked,b=ko.bindingHandlers.value;valerie.koBindingsHelper={useOriginalBindingHandlers:function(){ko.bindingHandlers.checked=a,ko.bindingHandlers.value=b},useValidatingBindingHandlers:function(){ko.bindingHandlers.checked=ko.bindingHandlers.validatedChecked,ko.bindingHandlers.value=ko.bindingHandlers.validatedValue}}}();