/* valerie - MIT license - (c) egrove Ltd (egrove.co.uk) */
var valerie={};(function(){"use strict";valerie.utils={};var e=valerie.utils;e.asArray=function(t){return e.isArray(t)?t:[t]},e.asFunction=function(t){return e.isFunction(t)?t:function(){return t}},e.isArray=function(e){return"[object Array]"==={}.toString.call(e)},e.isArrayOrObject=function(e){return null===e?!1:"object"==typeof e},e.isFunction=function(e){return null==e?!1:"function"==typeof e},e.isMissing=function(t){return null==t?!0:e.isString(t)?0===t.length:!1},e.isObject=function(t){return null===t?!1:e.isArray(t)?!1:"object"==typeof t},e.isString=function(e){return"[object String]"==={}.toString.call(e)},e.mergeOptions=function(t,i){var n,a,s={};null==t&&(t={}),null==i&&(i={});for(n in t)t.hasOwnProperty(n)&&(a=t[n],e.isArray(a)&&(a=a.slice(0)),s[n]=a);for(n in i)i.hasOwnProperty(n)&&(s[n]=i[n]);return s}})(),function(){"use strict";valerie.formatting={};var e=valerie.formatting;e.addThousandsSeparator=function(e,t,i){var n=(""+e).split(i),a=n[0];return a=a.replace(/\B(?=(\d{3})+(?!\d))/g,t),n[0]=a,n.join(i)},e.pad=function(e,t,i){return e=""+e,e.length>=i?e:Array(i+1-e.length).join(t)+e},e.replacePlaceholders=function(e,t){return null==t&&(t={}),e.replace(/\{(\w+)\}/g,function(e,i){var n=t[i];return null==n?e:""+n})}}(),function(){"use strict";valerie.dom={};var e=/\s+/g,t=/^\s+|\s+$/g,i=valerie.dom;i.classNamesDictionaryToString=function(e){var t,i=[];for(t in e)e.hasOwnProperty(t)&&e[t]&&i.push(t);return i.sort(),i.join(" ")},i.classNamesStringToDictionary=function(i){var n,a,s={};if(null==i)return s;if(i=i.replace(t,""),0===i.length)return s;for(n=i.split(e),a=0;n.length>a;a++)s[n[a]]=!0;return s},i.setElementVisibility=function(e,t){var i="none"!==e.style.display;i!==t&&(e.style.display=t?"":"none")}}(),function(){"use strict";valerie.koExtras={},valerie.koExtras.isolatedBindingHandler=function(e,t){var i=1===arguments.length?function(){}:e;return t=2===arguments.length?t:e,{init:function(e,n,a,s,r){i(e,n,a,s,r),ko.computed({read:function(){t(e,n,a,s,r)},disposeWhenNodeIsRemoved:e})}}},valerie.koExtras.pausableComputed=function(e,t,i,n){var a,s,r;return s=null==n?ko.observable(!1):ko.utils.isSubscribable(n)?n:ko.observable(n),r=ko.computed(function(){return s()?a:e.call(t)},t,i),r.paused=ko.computed({read:function(){return s()},write:function(e){e&&(e=!0),e!==s()&&(e&&(a=r()),s(e))}}),r.refresh=function(){s()&&(s(!1),a=r(),s(!0))},r}}(),function(){"use strict";valerie.converters={},valerie.converters.passThrough={format:function(e){return null==e?"":""+e},parse:function(e){return e}}}(),function(){"use strict";var e={failed:{},passed:{},pending:{}};valerie.ValidationResult=function(t,i){null==i&&(i=""),this.state=t,this.message=i,this.failed=t===e.failed,this.passed=t===e.passed,this.pending=t===e.pending},valerie.ValidationResult.states=e,valerie.ValidationResult.passedInstance=new valerie.ValidationResult(e.passed),valerie.ValidationResult.pendingInstance=new valerie.ValidationResult(e.pending),valerie.ValidationResult.createFailedResult=function(t){return new valerie.ValidationResult(e.failed,t)}}(),function(){"use strict";valerie.validationState={};var e="validation",t=valerie.utils;valerie.validationState.findIn=function(e,i,n,a){1 in arguments||(i=!0),2 in arguments||(n=!1),3 in arguments||(a=[]);var s,r,l;for(s in e)if(e.hasOwnProperty(s)){if(l=e[s],null==l)continue;if(r=valerie.validationState.getFor(l),ko.isObservable(l)&&(l=l.peek()),t.isFunction(l))continue;r&&(r instanceof valerie.PropertyValidationState?a.push(r):i&&a.push(r)),n&&t.isArrayOrObject(l)&&valerie.validationState.findIn(l,i,!0,a)}return a},valerie.validationState.getFor=function(t){return null==t?null:t.hasOwnProperty(e)?t[e]():null},valerie.validationState.has=function(t){return null==t?!1:t.hasOwnProperty(e)},valerie.validationState.setFor=function(t,i){t[e]=function(){return i}}}(),function(){"use strict";var e={deferEvaluation:!0},t=valerie.utils,i=valerie.ValidationResult.passedInstance,n=valerie.ValidationResult.pendingInstance,a=ko.observable,s=ko.computed,r=function(){return this.result().failed},l=function(){var e,t,i,n=[],a=this.validationStates();for(i=0;a.length>i;i++)e=a[i],e.isApplicable()&&(t=e.result(),t.failed&&n.push(e));return n},u=function(){return this.result().message},o=function(){return this.result().passed},d=function(){return this.result().pending},c=function(){var e,t,i=[],n=this.validationStates();for(t=0;n.length>t;t++)e=n[t],e.isApplicable()&&e.result().pending&&i.push(e);return i},v=function(){return this.failedStates().length>0?valerie.ValidationResult.createFailedResult(this.settings.failureMessageFormat):this.pendingStates().length>0?n:i},f=function(){var e,t=this.validationStates();for(e=0;t.length>e;e++)if(t[e].touched())return!0;return!1},h=function(e){var t,i,n=this.validationStates();for(t=0;n.length>t;t++)i=n[t],i.isApplicable()&&i.touched(e)};valerie.ModelValidationState=function(i,n){n=t.mergeOptions(valerie.ModelValidationState.defaultOptions,n),n.applicable=t.asFunction(n.applicable),n.name=t.asFunction(n.name),this.failed=s(r,this,e),this.failedStates=s(l,this,e),this.message=s(u,this,e),this.model=i,this.passed=s(o,this,e),this.pending=s(d,this,e),this.pendingStates=s(c,this,e),this.result=valerie.koExtras.pausableComputed(v,this,e,n.paused),this.paused=this.result.paused,this.refresh=this.result.refresh,this.settings=n,this.getName=function(){return this.settings.name()},this.isApplicable=function(){return this.settings.applicable()},this.summary=a([]),this.touched=s({read:f,write:h,deferEvaluation:!0,owner:this}),this.validationStates=ko.observableArray()},valerie.ModelValidationState.prototype={addValidationStates:function(e){return e=t.asArray(e),this.validationStates.push.apply(this.validationStates,e),this},applicable:function(e){return null==e&&(e=!0),this.settings.applicable=t.asFunction(e),this},clearSummary:function(e){var t,i,n;if(this.summary([]),e)for(t=this.validationStates(),n=0;t.length>n;n++)i=t[n],i.clearSummary&&i.clearSummary(!0);return this},end:function(){return this.model},includeInSummary:function(){return this.settings.excludeFromSummary=!1,this},name:function(e){return this.settings.name=t.asFunction(e),this},removeValidationStates:function(e){return e=t.asArray(e),this.validationStates.removeAll(e),this},startValidatingSubModel:function(e){return this.validationStates.push(e.validation()),this},stopValidatingSubModel:function(e){return this.validationStates.remove(e.validation()),this},updateSummary:function(e){var t,i,n=this.failedStates(),a=[];for(i=0;n.length>i;i++)t=n[i],t.settings.excludeFromSummary||a.push({name:t.getName(),message:t.message()});if(this.summary(a),e)for(n=this.validationStates(),i=0;n.length>i;i++)t=n[i],t.isApplicable()&&t.updateSummary&&t.updateSummary(!0);return this},validateAll:function(){var e=valerie.validationState.findIn(this.model,!0,!0);return this.addValidationStates(e),this},validateAllProperties:function(){var e=valerie.validationState.findIn(this.model,!1,!0);return this.addValidationStates(e),this},validateChildProperties:function(){var e=valerie.validationState.findIn(this.model,!1,!1);return this.addValidationStates(e),this},validateChildPropertiesAndSubModels:function(){var e=valerie.validationState.findIn(this.model,!0,!1);return this.addValidationStates(e),this}},valerie.ModelValidationState.defaultOptions={applicable:t.asFunction(!0),excludeFromSummary:!0,failureMessageFormat:"",name:t.asFunction("(?)"),paused:null},valerie.validatableModel=function(e,t){var i=new valerie.ModelValidationState(e,t);return valerie.validationState.setFor(e,i),i}}(),function(){"use strict";var e={deferEvaluation:!0},t=valerie.utils,i=valerie.formatting,n=valerie.koExtras,a=ko.observable,s=ko.computed,r=valerie.ValidationResult.passedInstance,l=function(e){var t=e.observableOrComputed(),i=e.settings.missingTest(t),n=e.settings.required();return i&&n?-1:i&&!n?0:1},u=function(e){var t,i,n,a=e.observableOrComputed(),s=e.settings.rules;for(n=0;s.length>n;n++)if(t=s[n],i=t.test(a),i.failed||i.pending)return i;return r},o=function(){return this.result().failed},d=function(){var e=this.result().message;return e=i.replacePlaceholders(e,{name:this.settings.name()})},c=function(){return this.result().passed},v=function(){return this.result().pending},f=function(){var e,t;return t=this.boundEntry.result(),t.failed?t:(e=l(this),-1===e?valerie.ValidationResult.createFailedResult(this.settings.missingFailureMessage):0===e?t:u(this))},h=function(){return this.settings.applicable()?this.touched()&&this.result().failed:!1};valerie.PropertyValidationState=function(i,l){l=t.mergeOptions(valerie.PropertyValidationState.defaultOptions,l),l.applicable=t.asFunction(l.applicable),l.name=t.asFunction(l.name),l.required=t.asFunction(l.required),this.boundEntry={focused:a(!1),result:a(r),textualInput:!1},this.failed=s(o,this,e),this.message=n.pausableComputed(d,this,e),this.passed=s(c,this,e),this.observableOrComputed=i,this.pending=s(v,this,e),this.result=s(f,this,e),this.settings=l,this.getName=function(){return this.settings.name()},this.isApplicable=function(){return this.settings.applicable()},this.showMessage=n.pausableComputed(h,this,e),this.touched=a(!1)},valerie.PropertyValidationState.prototype={addRule:function(e){return this.settings.rules.push(e),this},applicable:function(e){return null==e&&(e=!0),this.settings.applicable=t.asFunction(e),this},end:function(){var e,t,i=this.settings,n=i.valueFormat,a=i.rules;for(e=0;a.length>e;e++)t=a[e].settings,t.valueFormat=n;return this.observableOrComputed},entryFormat:function(e){return this.settings.entryFormat=e,this},excludeFromSummary:function(){return this.settings.excludeFromSummary=!0,this},name:function(e){return this.settings.name=t.asFunction(e),this},required:function(e){return null==e&&(e=!0),this.settings.required=t.asFunction(e),this},valueFormat:function(e){return this.settings.valueFormat=e,this}},valerie.PropertyValidationState.defaultOptions={applicable:t.asFunction(!0),converter:valerie.converters.passThrough,entryFormat:null,excludeFromSummary:!1,invalidEntryFailureMessage:"",missingFailureMessage:"",missingTest:t.isMissing,name:t.asFunction(),required:t.asFunction(!1),rules:[],valueFormat:null},valerie.validatableProperty=function(e,t){if(!ko.isSubscribable(e))throw"Only observables or computeds can be made validatable properties.";var i=new valerie.PropertyValidationState(e,t);return valerie.validationState.setFor(e,i),i}}(),function(){"use strict";ko.computed.fn.validate=function(e){return valerie.validatableProperty(this,e)}}(),function(){"use strict";ko.observable.fn.validate=function(e){return valerie.validatableProperty(this,e)},ko.observableArray.fn.validateAsModel=function(e){return valerie.validatableModel(this,e)},ko.observableArray.fn.propertyValidationState=function(e){return new valerie.PropertyValidationState(this,e)}}(),function(){"use strict";var e=ko.bindingHandlers.checked,t=ko.bindingHandlers.value;valerie.koBindingsHelper={setTextContent:function(e,t){ko.bindingHandlers.text.update(e,function(){return t})},useOriginalBindingHandlers:function(){ko.bindingHandlers.checked=e,ko.bindingHandlers.value=t},useValidatingBindingHandlers:function(){ko.bindingHandlers.checked=ko.bindingHandlers.validatedChecked,ko.bindingHandlers.value=ko.bindingHandlers.validatedValue}}}(),function(){"use strict";var e=valerie.ValidationResult.passedInstance,t=valerie.utils,i=valerie.dom,n=i.setElementVisibility,a=valerie.converters,s=valerie.validationState.getFor,r=ko.bindingHandlers,l=valerie.koBindingsHelper,u=ko.utils.registerEventHandler,o=valerie.koExtras.isolatedBindingHandler,d=/^(\s|\u00A0)+|(\s|\u00A0)+$/g;(function(){var i=r.checked,n=r.value,a=function(e,t){var i=s(t);i.touched(!0),i.boundEntry.focused(!1),i.message.paused(!1),i.showMessage.paused(!1)},l=function(e,t){var i,n=s(t);n.boundEntry.result.peek().failed||(i=t.peek(),e.value=n.settings.converter.format(i,n.settings.entryFormat))},o=function(e,t){var i=s(t);i.boundEntry.focused(!0),i.message.paused(!0),i.showMessage.paused(!0)},c=function(t,i){var n,a=(t.value||"").replace(d,""),r=s(i),l=r.settings,u=e;0===a.length?(i(null),l.required()&&(u=valerie.ValidationResult.createFailedResult(l.missingFailureMessage))):(n=l.converter.parse(a),i(n),null==n&&(u=valerie.ValidationResult.createFailedResult(l.invalidEntryFailureMessage))),r.boundEntry.result(u)},v=function(t,i,n){var a=t();i.boundEntry.focused.peek()||(i.boundEntry.result(e),n.value=i.settings.converter.format(a,i.settings.entryFormat))};r.validatedChecked={init:function(e,n,r,l,o){var d=n(),c=s(d);i.init(e,n,r,l,o),c&&(u(e,"blur",function(){a(e,d)}),null==c.settings.name()&&(c.settings.name=t.asFunction(e.name)))},update:i.update},r.validatedValue={init:function(e,i,r,d,f){var h,p,g=i(),m=s(g);return m?(null==m.settings.name()&&(m.settings.name=t.asFunction(e.name)),u(e,"blur",function(){a(e,g)}),h=e.tagName.toLowerCase(),(p="input"===h&&"text"===e.type.toLowerCase()||"textarea"===h)?(m.boundEntry.textualInput=!0,u(e,"blur",function(){l(e,g)}),u(e,"focus",function(){o(e,g)}),u(e,"keyup",function(){c(e,g)}),ko.computed({read:function(){v(g,m,e)},disposeWhenNodeIsRemoved:e}),void 0):(n.init(e,i,r,d,f),void 0)):(n.init(e,i,r,d,f),void 0)},update:function(e,t,i,a,r){var l=t(),u=s(l);u&&u.boundEntry.textualInput||n.update(e,t,i,a,r)}}})(),function(){var e=function(e,t,i,n,a){var r,l=n(),u=i();u===!0&&(u=l.value||l.checked||l.validatedValue||l.validatedChecked||a),r=s(u),r&&e(r,u,l)};r.disabledWhenNotValid=o(function(t,i,n,a){var s=function(e){t.disabled=!e.passed()};e(s,t,i,n,a)}),r.disabledWhenTouchedAndNotValid=o(function(t,i,n,a){var s=function(e){t.disabled=e.touched()&&!e.passed()};e(s,t,i,n,a)}),r.enabledWhenApplicable=o(function(t,i,n,a){var s=function(e){t.disabled=!e.settings.applicable()};e(s,t,i,n,a)}),r.formattedText=o(function(e,t,i){var n,r=i(),u=t(),o=ko.utils.unwrapObservable(u),d=s(u),c=a.passThrough.format;d&&(c=d.settings.converter.format,n=d.settings.valueFormat),c=r.formatter||c,null==n&&(n=r.valueFormat);var v=c(o,n);l.setTextContent(e,v)}),r.validationCss=o(function(t,n,a,s){var l=function(e){var n=r.validationCss.classNames,a=t.className,s=i.classNamesStringToDictionary(a),l=e.failed(),u=!1,o=e.passed(),d=e.pending(),c=e.touched(),v=!c;e.boundEntry&&e.boundEntry.focused()&&(u=!0),s[n.failed]=l,s[n.focused]=u,s[n.passed]=o,s[n.pending]=d,s[n.touched]=c,s[n.untouched]=v,t.className=i.classNamesDictionaryToString(s)};e(l,t,n,a,s)}),r.validationCss.classNames={failed:"failed",focused:"focused",passed:"passed",pending:"pending",touched:"touched",untouched:"untouched"},r.validationMessage=o(function(t,i,a,s){var r=function(e){n(t,e.showMessage());var i=e.message();l.setTextContent(t,i)};e(r,t,i,a,s)}),r.validationMessageText=o(function(t,i,n,a){var s=function(e){var i=e.message();l.setTextContent(t,i)};e(s,t,i,n,a)}),r.visibleWhenApplicable=o(function(t,i,a,s){var r=function(e){n(t,e.isApplicable())};e(r,t,i,a,s)}),r.visibleWhenFocused=o(function(t,i,a,s){var r=function(e){n(t,e.focused())};e(r,t,i,a,s)}),r.visibleWhenInvalid=o(function(t,i,a,s){var r=function(e){n(t,e.failed())};e(r,t,i,a,s)}),r.visibleWhenSummaryNotEmpty=o(function(t,i,a,s){var r=function(e){n(t,e.summary().length>0)};e(r,t,i,a,s)}),r.visibleWhenTouched=o(function(t,i,a,s){var r=function(e){n(t,e.touched())};e(r,t,i,a,s)}),r.visibleWhenUntouched=o(function(t,i,a,s){var r=function(e){n(t,!e.touched())};e(r,t,i,a,s)}),r.visibleWhenValid=o(function(t,i,a,s){var r=function(e){n(t,e.passed())};e(r,t,i,a,s)})}()}();